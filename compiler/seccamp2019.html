<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
    "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="ja">
<head>
<meta http-equiv="Content-Type" content="application/xhtml+xml; charset=UTF-8" />
<meta name="generator" content="AsciiDoc 8.6.10" />
<meta name="robots" content="noindex,nofollow,noarchive">
<meta name="twitter:card" content="summary">
<meta name="twitter:creator" content="@_hiromi_mi">
<meta name="twitter:title" content="セキュリティキャンプの応募用紙">
<meta name="twitter:description" content="hiromi_mi によるセキュリティキャンプ2019 Yトラック Y-II Cコンパイラ自作ゼミの応募用紙">
<meta name="twitter:image" content="icon_github.png">

<title>hiromi_mi によるセキュリティキャンプ2019 Yトラック Y-II Cコンパイラ自作ゼミの応募用紙</title>
<style type="text/css">
/* Shared CSS for AsciiDoc xhtml11 and html5 backends */

/* Default font. */
body {
  font-family: Georgia,serif;
}

/* Title font. */
h1, h2, h3, h4, h5, h6,
div.title, caption.title,
thead, p.table.header,
#toctitle,
#author, #revnumber, #revdate, #revremark,
#footer {
  font-family: Arial,Helvetica,sans-serif;
}

body {
  margin: 1em 5% 1em 5%;
}

a {
  color: blue;
  text-decoration: underline;
}
a:visited {
  color: fuchsia;
}

em {
  font-style: italic;
  color: navy;
}

strong {
  font-weight: bold;
  color: #083194;
}

h1, h2, h3, h4, h5, h6 {
  color: #527bbd;
  margin-top: 1.2em;
  margin-bottom: 0.5em;
  line-height: 1.3;
}

h1, h2, h3 {
  border-bottom: 2px solid silver;
}
h2 {
  padding-top: 0.5em;
}
h3 {
  float: left;
}
h3 + * {
  clear: left;
}
h5 {
  font-size: 1.0em;
}

div.sectionbody {
  margin-left: 0;
}

hr {
  border: 1px solid silver;
}

p {
  margin-top: 0.5em;
  margin-bottom: 0.5em;
}

ul, ol, li > p {
  margin-top: 0;
}
ul > li     { color: #aaa; }
ul > li > * { color: black; }

.monospaced, code, pre {
  font-family: "Courier New", Courier, monospace;
  font-size: inherit;
  color: navy;
  padding: 0;
  margin: 0;
}
pre {
  white-space: pre-wrap;
}

#author {
  color: #527bbd;
  font-weight: bold;
  font-size: 1.1em;
}
#email {
}
#revnumber, #revdate, #revremark {
}

#footer {
  font-size: small;
  border-top: 2px solid silver;
  padding-top: 0.5em;
  margin-top: 4.0em;
}
#footer-text {
  float: left;
  padding-bottom: 0.5em;
}
#footer-badges {
  float: right;
  padding-bottom: 0.5em;
}

#preamble {
  margin-top: 1.5em;
  margin-bottom: 1.5em;
}
div.imageblock, div.exampleblock, div.verseblock,
div.quoteblock, div.literalblock, div.listingblock, div.sidebarblock,
div.admonitionblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.admonitionblock {
  margin-top: 2.0em;
  margin-bottom: 2.0em;
  margin-right: 10%;
  color: #606060;
}

div.content { /* Block element content. */
  padding: 0;
}

/* Block element titles. */
div.title, caption.title {
  color: #527bbd;
  font-weight: bold;
  text-align: left;
  margin-top: 1.0em;
  margin-bottom: 0.5em;
}
div.title + * {
  margin-top: 0;
}

td div.title:first-child {
  margin-top: 0.0em;
}
div.content div.title:first-child {
  margin-top: 0.0em;
}
div.content + div.title {
  margin-top: 0.0em;
}

div.sidebarblock > div.content {
  background: #ffffee;
  border: 1px solid #dddddd;
  border-left: 4px solid #f0f0f0;
  padding: 0.5em;
}

div.listingblock > div.content {
  border: 1px solid #dddddd;
  border-left: 5px solid #f0f0f0;
  background: #f8f8f8;
  padding: 0.5em;
}

div.quoteblock, div.verseblock {
  padding-left: 1.0em;
  margin-left: 1.0em;
  margin-right: 10%;
  border-left: 5px solid #f0f0f0;
  color: #888;
}

div.quoteblock > div.attribution {
  padding-top: 0.5em;
  text-align: right;
}

div.verseblock > pre.content {
  font-family: inherit;
  font-size: inherit;
}
div.verseblock > div.attribution {
  padding-top: 0.75em;
  text-align: left;
}
/* DEPRECATED: Pre version 8.2.7 verse style literal block. */
div.verseblock + div.attribution {
  text-align: left;
}

div.admonitionblock .icon {
  vertical-align: top;
  font-size: 1.1em;
  font-weight: bold;
  text-decoration: underline;
  color: #527bbd;
  padding-right: 0.5em;
}
div.admonitionblock td.content {
  padding-left: 0.5em;
  border-left: 3px solid #dddddd;
}

div.exampleblock > div.content {
  border-left: 3px solid #dddddd;
  padding-left: 0.5em;
}

div.imageblock div.content { padding-left: 0; }
span.image img { border-style: none; vertical-align: text-bottom; }
a.image:visited { color: white; }

dl {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
dt {
  margin-top: 0.5em;
  margin-bottom: 0;
  font-style: normal;
  color: navy;
}
dd > *:first-child {
  margin-top: 0.1em;
}

ul, ol {
    list-style-position: outside;
}
ol.arabic {
  list-style-type: decimal;
}
ol.loweralpha {
  list-style-type: lower-alpha;
}
ol.upperalpha {
  list-style-type: upper-alpha;
}
ol.lowerroman {
  list-style-type: lower-roman;
}
ol.upperroman {
  list-style-type: upper-roman;
}

div.compact ul, div.compact ol,
div.compact p, div.compact p,
div.compact div, div.compact div {
  margin-top: 0.1em;
  margin-bottom: 0.1em;
}

tfoot {
  font-weight: bold;
}
td > div.verse {
  white-space: pre;
}

div.hdlist {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
div.hdlist tr {
  padding-bottom: 15px;
}
dt.hdlist1.strong, td.hdlist1.strong {
  font-weight: bold;
}
td.hdlist1 {
  vertical-align: top;
  font-style: normal;
  padding-right: 0.8em;
  color: navy;
}
td.hdlist2 {
  vertical-align: top;
}
div.hdlist.compact tr {
  margin: 0;
  padding-bottom: 0;
}

.comment {
  background: yellow;
}

.footnote, .footnoteref {
  font-size: 0.8em;
}

span.footnote, span.footnoteref {
  vertical-align: super;
}

#footnotes {
  margin: 20px 0 20px 0;
  padding: 7px 0 0 0;
}

#footnotes div.footnote {
  margin: 0 0 5px 0;
}

#footnotes hr {
  border: none;
  border-top: 1px solid silver;
  height: 1px;
  text-align: left;
  margin-left: 0;
  width: 20%;
  min-width: 100px;
}

div.colist td {
  padding-right: 0.5em;
  padding-bottom: 0.3em;
  vertical-align: top;
}
div.colist td img {
  margin-top: 0.3em;
}

@media print {
  #footer-badges { display: none; }
}

#toc {
  margin-bottom: 2.5em;
}

#toctitle {
  color: #527bbd;
  font-size: 1.1em;
  font-weight: bold;
  margin-top: 1.0em;
  margin-bottom: 0.1em;
}

div.toclevel0, div.toclevel1, div.toclevel2, div.toclevel3, div.toclevel4 {
  margin-top: 0;
  margin-bottom: 0;
}
div.toclevel2 {
  margin-left: 2em;
  font-size: 0.9em;
}
div.toclevel3 {
  margin-left: 4em;
  font-size: 0.9em;
}
div.toclevel4 {
  margin-left: 6em;
  font-size: 0.9em;
}

span.aqua { color: aqua; }
span.black { color: black; }
span.blue { color: blue; }
span.fuchsia { color: fuchsia; }
span.gray { color: gray; }
span.green { color: green; }
span.lime { color: lime; }
span.maroon { color: maroon; }
span.navy { color: navy; }
span.olive { color: olive; }
span.purple { color: purple; }
span.red { color: red; }
span.silver { color: silver; }
span.teal { color: teal; }
span.white { color: white; }
span.yellow { color: yellow; }

span.aqua-background { background: aqua; }
span.black-background { background: black; }
span.blue-background { background: blue; }
span.fuchsia-background { background: fuchsia; }
span.gray-background { background: gray; }
span.green-background { background: green; }
span.lime-background { background: lime; }
span.maroon-background { background: maroon; }
span.navy-background { background: navy; }
span.olive-background { background: olive; }
span.purple-background { background: purple; }
span.red-background { background: red; }
span.silver-background { background: silver; }
span.teal-background { background: teal; }
span.white-background { background: white; }
span.yellow-background { background: yellow; }

span.big { font-size: 2em; }
span.small { font-size: 0.6em; }

span.underline { text-decoration: underline; }
span.overline { text-decoration: overline; }
span.line-through { text-decoration: line-through; }

div.unbreakable { page-break-inside: avoid; }


/*
 * xhtml11 specific
 *
 * */

div.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.tableblock > table {
  border: 3px solid #527bbd;
}
thead, p.table.header {
  font-weight: bold;
  color: #527bbd;
}
p.table {
  margin-top: 0;
}
/* Because the table frame attribute is overriden by CSS in most browsers. */
div.tableblock > table[frame="void"] {
  border-style: none;
}
div.tableblock > table[frame="hsides"] {
  border-left-style: none;
  border-right-style: none;
}
div.tableblock > table[frame="vsides"] {
  border-top-style: none;
  border-bottom-style: none;
}


/*
 * html5 specific
 *
 * */

table.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
thead, p.tableblock.header {
  font-weight: bold;
  color: #527bbd;
}
p.tableblock {
  margin-top: 0;
}
table.tableblock {
  border-width: 3px;
  border-spacing: 0px;
  border-style: solid;
  border-color: #527bbd;
  border-collapse: collapse;
}
th.tableblock, td.tableblock {
  border-width: 1px;
  padding: 4px;
  border-style: solid;
  border-color: #527bbd;
}

table.tableblock.frame-topbot {
  border-left-style: hidden;
  border-right-style: hidden;
}
table.tableblock.frame-sides {
  border-top-style: hidden;
  border-bottom-style: hidden;
}
table.tableblock.frame-none {
  border-style: hidden;
}

th.tableblock.halign-left, td.tableblock.halign-left {
  text-align: left;
}
th.tableblock.halign-center, td.tableblock.halign-center {
  text-align: center;
}
th.tableblock.halign-right, td.tableblock.halign-right {
  text-align: right;
}

th.tableblock.valign-top, td.tableblock.valign-top {
  vertical-align: top;
}
th.tableblock.valign-middle, td.tableblock.valign-middle {
  vertical-align: middle;
}
th.tableblock.valign-bottom, td.tableblock.valign-bottom {
  vertical-align: bottom;
}


/*
 * manpage specific
 *
 * */

body.manpage h1 {
  padding-top: 0.5em;
  padding-bottom: 0.5em;
  border-top: 2px solid silver;
  border-bottom: 2px solid silver;
}
body.manpage h2 {
  border-style: none;
}
body.manpage div.sectionbody {
  margin-left: 3em;
}

@media print {
  body.manpage div#toc { display: none; }
}


</style>
<script type="text/javascript">
/*<![CDATA[*/
var asciidoc = {  // Namespace.

/////////////////////////////////////////////////////////////////////
// Table Of Contents generator
/////////////////////////////////////////////////////////////////////

/* Author: Mihai Bazon, September 2002
 * http://students.infoiasi.ro/~mishoo
 *
 * Table Of Content generator
 * Version: 0.4
 *
 * Feel free to use this script under the terms of the GNU General Public
 * License, as long as you do not remove or alter this notice.
 */

 /* modified by Troy D. Hanson, September 2006. License: GPL */
 /* modified by Stuart Rackham, 2006, 2009. License: GPL */

// toclevels = 1..4.
toc: function (toclevels) {

  function getText(el) {
    var text = "";
    for (var i = el.firstChild; i != null; i = i.nextSibling) {
      if (i.nodeType == 3 /* Node.TEXT_NODE */) // IE doesn't speak constants.
        text += i.data;
      else if (i.firstChild != null)
        text += getText(i);
    }
    return text;
  }

  function TocEntry(el, text, toclevel) {
    this.element = el;
    this.text = text;
    this.toclevel = toclevel;
  }

  function tocEntries(el, toclevels) {
    var result = new Array;
    var re = new RegExp('[hH]([1-'+(toclevels+1)+'])');
    // Function that scans the DOM tree for header elements (the DOM2
    // nodeIterator API would be a better technique but not supported by all
    // browsers).
    var iterate = function (el) {
      for (var i = el.firstChild; i != null; i = i.nextSibling) {
        if (i.nodeType == 1 /* Node.ELEMENT_NODE */) {
          var mo = re.exec(i.tagName);
          if (mo && (i.getAttribute("class") || i.getAttribute("className")) != "float") {
            result[result.length] = new TocEntry(i, getText(i), mo[1]-1);
          }
          iterate(i);
        }
      }
    }
    iterate(el);
    return result;
  }

  var toc = document.getElementById("toc");
  if (!toc) {
    return;
  }

  // Delete existing TOC entries in case we're reloading the TOC.
  var tocEntriesToRemove = [];
  var i;
  for (i = 0; i < toc.childNodes.length; i++) {
    var entry = toc.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div'
     && entry.getAttribute("class")
     && entry.getAttribute("class").match(/^toclevel/))
      tocEntriesToRemove.push(entry);
  }
  for (i = 0; i < tocEntriesToRemove.length; i++) {
    toc.removeChild(tocEntriesToRemove[i]);
  }

  // Rebuild TOC entries.
  var entries = tocEntries(document.getElementById("content"), toclevels);
  for (var i = 0; i < entries.length; ++i) {
    var entry = entries[i];
    if (entry.element.id == "")
      entry.element.id = "_toc_" + i;
    var a = document.createElement("a");
    a.href = "#" + entry.element.id;
    a.appendChild(document.createTextNode(entry.text));
    var div = document.createElement("div");
    div.appendChild(a);
    div.className = "toclevel" + entry.toclevel;
    toc.appendChild(div);
  }
  if (entries.length == 0)
    toc.parentNode.removeChild(toc);
},


/////////////////////////////////////////////////////////////////////
// Footnotes generator
/////////////////////////////////////////////////////////////////////

/* Based on footnote generation code from:
 * http://www.brandspankingnew.net/archive/2005/07/format_footnote.html
 */

footnotes: function () {
  // Delete existing footnote entries in case we're reloading the footnodes.
  var i;
  var noteholder = document.getElementById("footnotes");
  if (!noteholder) {
    return;
  }
  var entriesToRemove = [];
  for (i = 0; i < noteholder.childNodes.length; i++) {
    var entry = noteholder.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div' && entry.getAttribute("class") == "footnote")
      entriesToRemove.push(entry);
  }
  for (i = 0; i < entriesToRemove.length; i++) {
    noteholder.removeChild(entriesToRemove[i]);
  }

  // Rebuild footnote entries.
  var cont = document.getElementById("content");
  var spans = cont.getElementsByTagName("span");
  var refs = {};
  var n = 0;
  for (i=0; i<spans.length; i++) {
    if (spans[i].className == "footnote") {
      n++;
      var note = spans[i].getAttribute("data-note");
      if (!note) {
        // Use [\s\S] in place of . so multi-line matches work.
        // Because JavaScript has no s (dotall) regex flag.
        note = spans[i].innerHTML.match(/\s*\[([\s\S]*)]\s*/)[1];
        spans[i].innerHTML =
          "[<a id='_footnoteref_" + n + "' href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
        spans[i].setAttribute("data-note", note);
      }
      noteholder.innerHTML +=
        "<div class='footnote' id='_footnote_" + n + "'>" +
        "<a href='#_footnoteref_" + n + "' title='Return to text'>" +
        n + "</a>. " + note + "</div>";
      var id =spans[i].getAttribute("id");
      if (id != null) refs["#"+id] = n;
    }
  }
  if (n == 0)
    noteholder.parentNode.removeChild(noteholder);
  else {
    // Process footnoterefs.
    for (i=0; i<spans.length; i++) {
      if (spans[i].className == "footnoteref") {
        var href = spans[i].getElementsByTagName("a")[0].getAttribute("href");
        href = href.match(/#.*/)[0];  // Because IE return full URL.
        n = refs[href];
        spans[i].innerHTML =
          "[<a href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
      }
    }
  }
},

install: function(toclevels) {
  var timerId;

  function reinstall() {
    asciidoc.footnotes();
    if (toclevels) {
      asciidoc.toc(toclevels);
    }
  }

  function reinstallAndRemoveTimer() {
    clearInterval(timerId);
    reinstall();
  }

  timerId = setInterval(reinstall, 500);
  if (document.addEventListener)
    document.addEventListener("DOMContentLoaded", reinstallAndRemoveTimer, false);
  else
    window.onload = reinstallAndRemoveTimer;
}

}
asciidoc.install();
/*]]>*/
</script>
</head>
<body class="article">
<div id="header">
<h1>hiromi_mi によるセキュリティキャンプ2019 Yトラック Y-II Cコンパイラ自作ゼミの応募用紙</h1>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph"><p><a href="https://github.com/hiromi-mi">hiromi-mi</a> です。セキュリティキャンプの応募用紙のうち、個人情報を削除したものを置いておきます。来年以降応募される方のうちどなたかにでも、反面教師となれれば幸いかなと思います。</p></div>
<div class="paragraph"><p>当時のものをあえて残してあります。間違いなど多くあるかと思います。</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_問1_これまでのプログラミング歴_c言語に限りません_について好きなだけ語ってください_何か作ったものがあれば_それについても教えてください">[問1] これまでのプログラミング歴（C言語に限りません）について好きなだけ語ってください。何か作ったものがあれば、それについても教えてください。</h2>
<div class="sectionbody">
<div class="paragraph"><p>(省略)
Excel + Visual Basic for Applications でクイズアプリを書いたり、中学校の同級生や後輩に Vim を教えた記憶があります。
また、円周率を計算させるために、逆正接関数を用いたものや、Gauss-Legendre のアルゴリズムを用いたものを MPFR などのライブラリを用いて作成し、それらの計算速度を比べたり、他の言語でも自作して C言語の早さに驚いた記憶があります。</p></div>
<div class="paragraph"><p>ここから、今まで作ってきたものでインターネット上に公開されてあるものを述べます。</p></div>
<div class="paragraph"><div class="title">vim-TermSingleton</div><p>Vim 8.1 にて :terminal というターミナルエミュレータ機能が実装されたことに対応し、Vim のターミナルエミュレータ機能の中でVim を開くことが可能になりましたが、Vim が多重に起動していると、レジスタなどが共有されないなど不便がありますなので、複数の Vim が開くとき Vim の clientserver 機能を用外側のVim で開くようにしました。</p></div>
<div class="paragraph"><p>(省略)</p></div>
<div class="paragraph"><div class="title">ljmp</div><p><a href="https://viewsourcecode.org/snaptoken/kilo/">Build Your Own Text Editor - Jeremy Ruten</a> をもとに実装したテキストエディタです。
この文章中で取り上げられている、基本的なモードレステキスト編集や、検索機能、構文強調機能に加え、日本語への対応や、コピーペースト機構、あるいは簡易なテキスト補完機能を実装しました。もともと 「1バイトが一文字」の考えなチュートリアルを自分の考えて多バイト対応させるのに苦労したおぼえがあります。</p></div>
<div class="paragraph"><div class="title">hanando-fukui</div><p>3月ごろから 実装していた C コンパイラです。万が一参加できることになれば、これを改造することになると考えています。</p></div>
<div class="paragraph"><p>そのほか、(省略)</p></div>
<div class="paragraph"><p>最後に、挫折したものは多すぎて書ききれませんが、例えば 正規表現エンジンの Oblaka (正規表現エンジンでは、正規表現をコンパイルして、JIT上で文字列を処理させることが多いですが、コンパイル部分がうまく動作しなかった) などがあります。</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_問2_コンパイラがソースコードから実行バイナリを生成する過程について_現在知っている範囲で説明してください_ソースコードの言語については_好きなものでかまいません">[問2] コンパイラがソースコードから実行バイナリを生成する過程について、現在知っている範囲で説明してください。ソースコードの言語については、好きなものでかまいません。</h2>
<div class="sectionbody">
<div class="paragraph"><p>C言語での過程について説明します。</p></div>
<div class="paragraph"><p>まずコンパイラはソースコードを読み込みます。ソースコードから入力された文字列を、Token の列に分割します。そこで、ただの連続した文字列を、要素別に分割します。
たとえば「345」といった数値であれば、int型の 345 という内容に置き換えたり、"文字列" を char型のポインタを用い持つようにします。
改行や空白など、C言語においてさしたる意味を持たないものは、ここで排除してしまうこともありますが、後述するプリプロセスでは改行が区切りとして意味がある場合があり、hanando-fukui の現時点での実装では TK_NEWLINE, TK_SPACE として残してあります。</p></div>
<div class="paragraph"><p>そののち、プリプロセスを行います。#define A B などとA の内容をB に置き換えたり、#include で他のファイルを取り込む (その際Tokenize とプリプロセスは再帰的に行なわれる) ことです。
なお、C言語においては、おおむね <em>;</em> を区切りとしていますが、プリプロセスでは (<em>;</em> に影響されないようにするためでしょうか) ( <em>\</em> 記号を除き) 改行をプリプロセスの区切りとしてあります。なので、hanando-fukui では、TK_NEWLINE, TK_SPACE をこの段階まで残し、プリプロセスの #include 文などの終わりを判断するのに使っています。
あるいは、この後で改行をもって判断する必要はなく、この段階で TK_NEWLINE, TK_SPACE を削除しています。</p></div>
<div class="paragraph"><p>次に、構文解析を行います。演算子や数値、変数などをノードに持つような木構造として今迄のデータを持つようにします。hanando-fukui では、再帰下降構文解析を行なっています。まず、Node という構造体で再帰的に木構造を表現します。木構造を生成するのには、文法規則の優先順位に従って作った再帰関数を用います。これにより、加法より乗法が優先されるといった演算規則が、再帰関数を呼ぶ際に、node_add() を呼ぶか node_mul() を呼ぶかの違いとして表現できます。</p></div>
<div class="paragraph"><p>その後に analyzing process を行います。そこで、構文解析時に検出できないエラーを検知したりします。
例えばに、C言語の仕様上では、構文解析しただけでは検知しにくいエラーがあります。
ポインタとポインタの加算はエラーですが、構文解析時に (少なくとも hanando-fukui では) 左辺と右辺の型情報を持っていないため、チェックすることが難しいです。
なお、現状の hanando-fukui では、analyzing process とコード生成時がごちゃまぜになっています。</p></div>
<div class="paragraph"><p>そして、必要に多じ 最適化プロセスを行います。
たとえば <code>i = (1 &lt;&lt; 2);</code> などといった定数同士の演算を先に実行しておき、<code>i = 4;</code> とします。
また、高度な例として、for 文のインライン展開があります。</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span><span style="color: #009900">int</span> i<span style="color: #990000">=</span><span style="color: #993399">1</span><span style="color: #990000">;</span>i<span style="color: #990000">&lt;=</span><span style="color: #993399">10</span><span style="color: #990000">;</span>i<span style="color: #990000">++)</span> <span style="color: #FF0000">{</span> <span style="color: #990000">&lt;</span>stmt<span style="color: #990000">&gt;;</span> <span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>を、<code>&lt;stmt&gt;</code> の10回の繰りかえしとして実装するものです。これにより、条件分岐処理を省くこバイナリサイズが肥大化するものの <code>&lt;stmt&gt;</code> の実行が速くなることが期待できます。
(hanando-fukui で実装してみようかとも思いましたが、 ad-hoc な形での実装以外思い浮かびません&#8230;)
なお、今迄のanalyzing process までは、生成したいバイナリのアーキテクチャに関わらず普遍的に作れるものでしたが、ここからは、生成したいバイナリのCPU がどのような命令を持っているか、それぞれの命令にはどのような (時間、メモリなど) 制約があるかに依存します。</p></div>
<div class="paragraph"><p>最後、具体的にアセンブリコード (あるいはバイナリ) を出力します。
hanando-fukui ではアセンブリコードを上から順番に出力するようになっているため、グローバル変数などを事前に <code>.comm</code> 疑似命令などを使い生成し、そのあと順番にアセンブリコードを出力します。当然これは出力する対象のアーキテクチャごとに異なります。
もちろんアーキテクチャごとに命令は異なりますし、風変わりなところでいえば、構造体のメモリ配置があります。</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">struct</span></span> <span style="color: #008080">Foo</span> <span style="color: #FF0000">{</span>
<span style="color: #009900">int</span> a<span style="color: #990000">;</span>
<span style="color: #009900">char</span> b<span style="color: #990000">;</span>
<span style="color: #009900">char</span> c<span style="color: #990000">;</span>
<span style="color: #009900">int</span><span style="color: #990000">*</span> d<span style="color: #990000">;</span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span></tt></pre></div></div>
<div class="paragraph"><p>という配列を考えます。メモリ上で最も場所を使わない配置を考えると、</p></div>
<div class="ulist"><ul>
<li>
<p>
a: (アドレス) 0,1,2,3
</p>
</li>
<li>
<p>
b: 4
</p>
</li>
<li>
<p>
c: 5
</p>
</li>
<li>
<p>
d: 6,7, &#8230;, 13
</p>
</li>
</ul></div>
<div class="paragraph"><p>となりますが、実際は、v := その変数の型のバイト数 として、アドレスはv で割り切れないといけません。また、これを満たすようにして、なるべく詰められてなければなりません。
なので、</p></div>
<div class="ulist"><ul>
<li>
<p>
a: (アドレス) 0,1,2,3
</p>
</li>
<li>
<p>
b: 4
</p>
</li>
<li>
<p>
c: 5 (char は1バイトなので)
</p>
</li>
<li>
<p>
d: 8,9, &#8230;, 15 ( int* は8バイトなので)
</p>
</li>
</ul></div>
<div class="paragraph"><p>となります。hanando-fukui ではこれを最初誤解しており、gcc でコンパイルされた構造体を扱う関数を hanando-fukui でコンパイルされたものから呼び出すと動作しない、といったバグになっていました。
話をもとにもどします。この段階ではABI も重要です。
例えば関数を呼び出す際、(可変長引数など例外がありますが) rdi, rax,&#8230;のレジスタに順番に引数の内容を格納し、戻り値はrbp レジスタにしまうようになっています。これはおおむねアプリケーションを実行するもの、具体的にはおおむねOS が定めています。これに従ってコンパイラはアセンブリコードを出力します。
以上は、C標準ライブラリだけを使った関数であっても、Windows 環境と Linux 環境においてアセンブリコードが (表記の方法以外でも) 異なることの理由でもあります。</p></div>
<div class="paragraph"><p>以上が基本的な経過ですが、gcc などのコンパイラにおいては、具体的に出力する前に中間言語を出力し、それに対する最適化プロセスを行ない、最後にアセンブリコードを出力することもあります。</p></div>
<div class="paragraph"><p>ここから、アセンブラが、具体的な命令に翻訳します。
これはアーキテクチャごとに大幅に状況が異なります。</p></div>
<div class="paragraph"><p>最後にリンカを用い、実際に実行できるプログラムを生成させまkす。
これは、ほとんどのプログラムは何かしらの外部ライブラリに依存しており、それを動的あるいは静的に繋げて関数を実行時に呼び出せるようにする必要があるからです。
リンカでは、まずアセンブラで出力したELF ファイルを読み込みます。また、(ほとんどの場合) /usr/lib/libc.so などのstandard library も読み込みます。
その中に含まれるシンボルテーブルを解析して、先のファイルで再配置が必要な箇所 (PLT32 など ELF のシンボルテーブル中に記されている) を見つけます。その後、standard library のどのファイルのどのシンボルが該当するものかを見つけて、静的リンクならファイルをELFヘッダなどを分けて結合します。一方動的リンクなら別途ELF ローダーに動的リンクである旨の指示をELF ヘッダにつけて、最後にバイナリを出力します。</p></div>
<div class="paragraph"><p>ちなみに <a href="https://github.com/hiromi-mi/portlinker">https://github.com/hiromi-mi/portlinker</a> というリンカの書きかけで、時間不足で途中で放置になっているものがあります。
もしhanando-fukui の完全な自己完結を目指すとならば、これを復旧させることになるかなと考えています。</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_問3_c言語のコンパイラを書く際に_最も難しいポイントはどこだと思いますか_考えたことや_これまでのプログラミング経験をもとに_具体的に教えてください">[問3] C言語のコンパイラを書く際に、最も難しいポイントはどこだと思いますか？考えたことや、これまでのプログラミング経験をもとに、具体的に教えてください。</h2>
<div class="sectionbody">
<div class="paragraph"><p>セルフホストにたどりつく前の考えと、たどりついた後では変化したので、その両方について記します。</p></div>
<div class="sect2">
<h3 id="_開発前_3月時点">開発前 (3月時点)</h3>
<div class="paragraph"><p>構文解析の部分が難しく感じました。</p></div>
<div class="paragraph"><p>ここでいう「難しさ」は、理論を読んでも、実際にソースコードでどのようになるのかイメージできずにいました。
例えば、トークンを生成したものを LR(1) 文法で読み取る、とだけ書かれてあっても、
どのようにデータ構造を持てばいいのか、再帰的に解けばいいのかfor なのか、理解に困難を覚えていました。
これはこのゼミの教科書にある説明のおかげで何となく理解できたように思えます。これは具体的にソースコードが書かれていたからだと思います。逆にいえば、理屈をきちんとソースコードに打ち込む能力の不足を感じさせられます。</p></div>
</div>
<div class="sect2">
<h3 id="_セルフホスト達成後_5月時点_に感じていること">セルフホスト達成後 (5月時点) に感じていること</h3>
<div class="paragraph"><p>バグを生み出さないようにする、あるいはバグの原因をつかんで解決することが難しく感じています。
例えば、(極論ですが) 構文解析などの理屈を理解するのには、(競技プログラミングや数学など) 他の能力が高かったり、分かりやすい前例があればある程度乗り越えられるとも感じました。</p></div>
<div class="paragraph"><p>それとは異なり、バグを見つけて取ることには、長い経験が必要で、かつ手元ではあまりうまく文章の形で残せない経験のようなものが必要ではと感じます。</p></div>
<div class="paragraph"><p>hanando-fukui で生み出したバグを取り上げ、以上の考えに至った経緯を説明します。
セルフホスト間近の状況です。(clang でコンパイルした第一世代の hanando がある状況で、それでコンパイルし生成された第二世代のコンパイラがうまく動作しない状況でした。そのなかで沢山のバグを取ることになりましたが、第二世代コンパイラが「動作しない」ということしか分からず、どこがおかしくなっているのか探索するのに苦労しました。
関数ごとに呼び出して動作がおかしいであろう関数で、セグメンテーション違反になるところをgdb で見つけて、その部分を逆アセンブルしました。そして、コンパイラが出力したアセンブリに対応するC言語ソースコードを見つけ、その部分がなぜそうなっているのかprintf などを入れて調べる&#8230; これを繰りかえして疲れを抱きました。
例えば、continue; 文 をコンパイラ内でよく使っていますが、それが異なる場所に飛んでいることに気付き、その原因は break; 文は continue; 文とは違い、switch 文中でも使えることを失念して、continue; 文もswitch で分割するようにした影響でした。
また、charとint 型との比較において、なにも考えず32-bit の領域で比較するようにした結果、char 型の中に未定領域が発生することに気づかなかったこともありました。いつか一致するはずの <code>*p++ == '\0'</code> でエラーとなり、そして無限ループで終了しなくなりました。
などなど、途方にくれることもありました。</p></div>
<div class="paragraph"><p>バグを見つけてなくしていく上で、以下のような対処が有意義だと感じました。バグを生まないようなプログラミング (思考) をセキュリティキャンプなどで少しでも身につけられたらよいと思います。</p></div>
<div class="paragraph"><div class="title">バージョン管理の意味</div><p>以前から Git、MercurialやPijul などでソースコードをバージョン管理下におくようにしていましたが、その有用性をあらためて感じました。
ソースコードを動く単位でコミットするなどして、「万一うまくいかない場合は戻す」ことができます。そして、<code>git bisect</code> を使うことで、どのコミットが原因なのかを特定することもできます。更に、コミットメッセージを書けば、どの機能をいつ実装したのか、なぜバグを生んだのかを書き残すこともできます。</p></div>
<div class="paragraph"><div class="title">テストコードを書く</div><p>テストコードを書くことで、ちょっとした変更がもたらす影響をすぐ把握できるようになりました。 予想外の場所に影響することが高い確率で把握できます。
ただ、複数の処理を単一のテストコードで書くことをあまりしなかったために発生したバグもあり、今後結合テストのように結合して処理させることもしたいと感じます。</p></div>
<div class="paragraph"><div class="title">問題のある部分を適切に切り出す</div><p>(これを事前に行なったのがテストコードを書くことかもしれません) 具体的には、hanando-fukui の samples/ フォルダの下にあるファイルですが、セルフホスト直前になって、どこの挙動がおかしいか調べるために、hanando-fukui 本体のソースコードからバグが発生してそうな箇所を抜き出してテストしました。このおかげで、本体の膨大な (1万行程度です) アセンブリコードにかわり、100行程度のアセンブリコードを相手に絞り込むことができるようになりました。</p></div>
<div class="paragraph"><div class="title">バグの記録を残す</div><p>バグを見つけて解決した際、なぜ解決できたのか、なぜ生んだのか (考慮漏れなのか、そもそも実装していない機能に依存していたのか、仕様の勘違いなのか) をコミットログなしは手元で意識することで、典型的なバグのパターンを少しなりとも見つけられるようになりました。</p></div>
<div class="paragraph"><p>例えば、最初型の概念をまともに持たず、全部 unsigned 64-bit 扱いしていたため、途中からコード生成部分や、新しい演算子を実装する際に、出力するのがこの型で正しいかどうか、気をようになるなどがありました。</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_問4_何か他にアピールしたいことがあれば_自由に書いてください_この設問も含め_誤ったことを書いていても減点はしません_書いておきたいことはなんでも書いてください">[問4] 何か他にアピールしたいことがあれば、自由に書いてください。この設問も含め、誤ったことを書いていても減点はしません。書いておきたいことはなんでも書いてください。</h2>
<div class="sectionbody">
<div class="paragraph"><p>今後やりたいことの案と、それに対してどんな技術的取り組みをすることになりそうかを書きしるします。</p></div>
<div class="sect2">
<h3 id="_0_レジスタマシンへの移行">0. レジスタマシンへの移行</h3>
<div class="paragraph"><p>スタックマシンでは、余計な <code>pop</code> や <code>push</code> 命令が多数発生し、それを最適化するのも手間がかかりそうです。なので、レジスタマシンに移行したい気持ちです。</p></div>
<div class="paragraph"><p>どのように実装すればよいのか分かっていないのが演算処理です。スタックマシンでは <em>+</em> を 左辺と右辺を計算したものを pop して加えて push する、というふうに実装できましたが、レジスタマシンでは加えた結果をどのように持つかが問題になります。
gcc のソースコードをコンパイルしてみると、rax, rdi などに順番に演算結果を入れているように見えますが、例えば <code>1 + (2 + (3 + (4 + (5 + ....) ))))))</code> と続いたときに、(最適化しない前提で) レジスタが全て埋まってしまうのではないか、さてどうしよう、ということで止まっています。</p></div>
</div>
<div class="sect2">
<h3 id="_1_デバッガの支援">1. デバッガの支援</h3>
<div class="paragraph"><p>セルフホストが近くなると、前述の通り苦労しながら沢山のバグをとることになりました。その時はprintf を使い(第二世代コンパイラの) 変数の値を眺めるようにしていましたが、何度もデバッガがほしいと思わされました。
そこで、デバッガの出力を支援するデータを与えて、今後の開発を楽にできるかと思います。</p></div>
<div class="paragraph"><p>まずやりたいと思っているのが、行番号機構の実装、つまりCソースコードベースでのステップ実行と、変数の値の表示です。
そのためには、デバッガに CFI (Call Frame Information) などを与える必要があります。以下分かっていることを列挙すると:</p></div>
<div class="ulist"><ul>
<li>
<p>
関数を .cfi_startproc と .cfi_endproc で囲みます。
</p>
</li>
<li>
<p>
push や pop があったときには、<code>.cfi_def_cfa_offset</code> として Call Frameのレジスタが移動したことを表します。
</p>
</li>
<li>
<p>
それぞれのレジスタの位置を、<code>.cfi_offset [レジスタ名] [オフセット]</code> として、記録しておきます。
</p>
</li>
<li>
<p>
アセンブリ中に現在のC言語中での行番号を打ち込むには、 <code>.loc</code> 疑似命令を使います。
</p>
</li>
</ul></div>
<div class="paragraph"><p>ただ、clang やgcc でコンパイルしてみると、ソースコード本体を出力したあとに、<code>.Ldebug_info</code> として、変数名と対応する長い情報が付いていますが、まだこれが何なのかを把握できずにいます。</p></div>
<div class="olist arabic"><div class="title">この項の参考文献</div><ol class="arabic">
<li>
<p>
Info Page of GNU as
</p>
</li>
<li>
<p>
<a href="http://babyron64.hatenablog.com/entry/2018/08/05/012956">デバッグ情報を探る 〜.cfi_xx命令の動作〜</a>
</p>
</li>
</ol></div>
</div>
<div class="sect2">
<h3 id="_2_c言語標準への準拠_double_などの浮動小数点型の実装">2. C言語標準への準拠 / double などの浮動小数点型の実装</h3>
<div class="paragraph"><p>特に初期の実装について、C言語の標準から乖離している箇所が多くあります。
例えば、C言語の仕様では、宣言と文や式が明確に分割されていますが、手元では明確には分離されておらず、その場しのぎになっています。例えば、goto 文などがgoto 式で扱われるようになっています。きれいにしようとしすぎて以前失敗した Oblaka などの例を思いだし、「セルフコンパイルするまではリファクタリングは避けよう」と考えて、ここまであえて放置していました。</p></div>
<div class="paragraph"><p>現状 double 型を実装するためには、 <code>mov</code> 命令を、<code>movzl</code> などと型に応じて書き換える必要がありますが、現状コード生成プロセスにおいては、ほとんど <code>mov</code> を出力するだけのソースコードになっており、そこを処理する必要があります。</p></div>
</div>
<div class="sect2">
<h3 id="_3_警告の充実">3. 警告の充実</h3>
<div class="paragraph"><p>C言語の仕様をうまく実装できてからになりますが、analyzing process をうまく使うことで、コンパイルする際に、未初期化の変数を検出するなどできるのではないかと考えました。
例えば変数を持つNode型に <code>is_used</code> <code>is_initialized</code> などの真偽値を導入し、構文解析の途中で、変数が使用されたり、代入されればtrue にする。analyzing process でその変数を読む際に、もしそこが false であれば警告を出せると思います。
また、単純なものに限りますがfor 文が無限ループになってしまう例を警告できるとも考えています。</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span><span style="color: #009900">int</span> i<span style="color: #990000">=</span><span style="color: #993399">10</span><span style="color: #990000">;</span>i<span style="color: #990000">&gt;=</span><span style="color: #993399">1</span><span style="color: #990000">;</span>i<span style="color: #990000">++</span> <span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<span style="font-style: italic"><span style="color: #9A1900">// i++ から i-- にするのを忘れている</span></span>
 <span style="font-style: italic"><span style="color: #9A1900">// for 文の中に break や return がない</span></span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>もちろん汎用なコンパイラではあまりこのような局所的な例に手間をかける意味はないと思いますが、セキュリティキャンプで作れるものとしたら、個性として持っておいて損はないと思います。</p></div>
</div>
<div class="sect2">
<h3 id="_4_c_objective_c_subset_compiler_を目指す">4. C++/Objective-C (Subset) Compiler を目指す</h3>
<div class="paragraph"><p>これはひとりでは到底出来る規模ではなさそうで、もしやるとしても複数人で分担することになりそうです。もちろんC++ という複雑な言語を丸ごと実装するのは困難であり、適度に省略することになりますが&#8230;</p></div>
<div class="paragraph"><p>まずやるとすれば、クラス機構の実装でしょうか。これは構造体を拡張すれば可能だと考えています。
ただ、山場となるのは仮想関数の実装だと考えています。普通の構造体と異なり、関数ポインタのテーブル vtable のアドレスを持たし、そのアドレスを間接的に参照し呼び出すことが必要です。</p></div>
<div class="paragraph"><p>参考文献: <a href="https://qiita.com/4_mio_11/items/aa71f18b24ab55e4cb3d">C++で学ぶ！メモリレイアウトとvtableのすゝめ　〜動的ポリモフィズムを実現する仕組み〜
</a></p></div>
<div class="paragraph"><p>さらにそこから実装していき、テンプレート機構まで向かいたい気持ちがありますが、どのように実装すればよいのか見当もついていません。</p></div>
<div class="paragraph"><p>また、これについては目標設定も悩んでいます。STL を使えるようになるには、テンプレートまでなど相当量を実装する必要があり、おそらく無理だろうと考えています。しかし、標準ライブラリをC言語のライブラリで代用すると、「C++ だ」と見せられるような素材に欠けるように思います。</p></div>
<div class="paragraph"><p>そこで、別案として Objective-C のコンパイラを目指す手も考えています。</p></div>
<div class="paragraph"><p>Objective-C はC言語を主軸にSmalltalk 由来のオブジェクト指向を加えたもので、NEXTSTEP をはじめとして、今でこそSwift が普及したものの、macOS や iOS 上での開発でよく採用されています。また、今でも GNUStep に依存すれば Linux 環境などでも動作します。
呼び出すメソッドを動的に変更できたり (-performSelector: など) 、カプセル化を無視してみたり、(カテゴリを使って) 既存のクラスに要素を追加できるなど異なる性質を持つおもしろい言語です。C++ と比べ言語仕様が小さく、クラス機構を実装してGNUstep にリンクして動かせたりしないかな、などと思っています。</p></div>
<div class="paragraph"><p>(この両方を実装し、オブジェクト指向の実装上での違いについて振りかえる文章を書けるとおもしろいのでは、とも思います。ただそれだけの規模について考える時間はないと思います。)</p></div>
</div>
<div class="sect2">
<h3 id="_5_最適化">5. 最適化</h3>
<div class="paragraph"><p>勿論最適化もおもしろいのではないかと考えます。レジスタマシン実装後、計算できるところは先に計算するなどできればと思います。また、C言語の簡易なインタプリタを内部に組込むことで、C++ 言語における constexpr 定数式 のようなものを再現して、コンパイル時に計算を終わられられればよいのかも、と思います。</p></div>
<div class="paragraph"><p>以上、あるいは他に他のアーキテクチャへの移植や、OSなし環境への対応などがやっていけたらなと思います。</p></div>
</div>
<div class="sect2">
<h3 id="_oss活動について">OSS活動について</h3>
<div class="paragraph"><p>(後略)</p></div>
</div>
</div>
</div>
</div>
<div id="footnotes"><hr /></div>
<div id="footer">
<div id="footer-text">
Last updated
 2019-05-27 16:20:24 JST
</div>
</div>
</body>
</html>
